<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Quản lý sửa chữa điện thoại</title>
<style>
  :root{
    --bg:#f7f8fa; --card:#ffffff; --ink:#1f2937; --muted:#6b7280;
    --accent:#2563eb; --accent-2:#10b981; --danger:#ef4444; --warn:#f59e0b;
    --border:#e5e7eb; --chip:#eef2ff;
  }
  *{box-sizing:border-box}
  body{margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji"; background:var(--bg); color:var(--ink)}
  header{position:sticky; top:0; z-index:10; background:var(--card); border-bottom:1px solid var(--border)}
  .wrap{max-width:1100px; margin:auto; padding:16px}
  h1{font-size:20px; margin:4px 0 0}
  .tabs{display:flex; gap:8px; padding:8px 0 12px; overflow:auto}
  .tab-btn{padding:10px 14px; border:1px solid var(--border); background:var(--card); border-radius:10px; cursor:pointer; font-weight:600; white-space:nowrap}
  .tab-btn.active{border-color:var(--accent); color:#fff; background:var(--accent)}
  .grid{display:grid; grid-template-columns: repeat(12,1fr); gap:10px}
  .card{background:var(--card); border:1px solid var(--border); border-radius:12px; padding:14px}
  label{font-size:12px; color:var(--muted); display:block; margin-bottom:4px}
  input, select, textarea{width:100%; padding:10px; border:1px solid var(--border); border-radius:10px; background:#fff}
  textarea{min-height:72px; resize:vertical}
  .row-6{grid-column: span 6}
  .row-4{grid-column: span 4}
  .row-3{grid-column: span 3}
  .row-12{grid-column: span 12}
  .actions{display:flex; gap:8px; flex-wrap:wrap}
  .btn{padding:10px 12px; border:1px solid var(--border); background:#fff; border-radius:10px; cursor:pointer; font-weight:600}
  .btn.primary{background:var(--accent); color:#fff; border-color:var(--accent)}
  .btn.success{background:var(--accent-2); color:#fff; border-color:var(--accent-2)}
  .btn.warn{background:var(--warn); color:#fff; border-color:var(--warn)}
  .btn.danger{background:var(--danger); color:#fff; border-color:var(--danger)}
  .btn.ghost{background:#fff}
  .toolbar{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
  .toolbar .chip{background:var(--chip); padding:6px 10px; border-radius:999px; font-size:12px}
  .table-wrap{overflow:auto; border:1px solid var(--border); border-radius:12px; background:#fff}
  table{border-collapse:collapse; width:100%; min-width:1000px}
  thead th{position:sticky; top:0; background:#fafafa; border-bottom:1px solid var(--border); text-align:left; font-size:12px; color:var(--muted); padding:10px}
  tbody td{border-top:1px solid var(--border); padding:10px; vertical-align:top}
  .status{font-size:12px; padding:4px 8px; border-radius:999px; display:inline-block}
  .st-received{background:#e0f2fe; color:#075985}
  .st-progress{background:#fef9c3; color:#92400e}
  .st-delivered{background:#dcfce7; color:#14532d}
  .st-debt{background:#fee2e2; color:#7f1d1d}
  .pill{font-size:12px; padding:4px 8px; border-radius:8px; background:#f3f4f6}
  .sum{display:flex; gap:12px; flex-wrap:wrap}
  .sum .kpi{background:var(--card); border:1px solid var(--border); padding:12px 14px; border-radius:12px}
  .kpi b{font-size:18px; display:block}
  .hint{color:var(--muted); font-size:12px}
  .nowrap{white-space:nowrap}
  @media (max-width: 800px){
    .row-6,.row-4,.row-3,.row-12{grid-column: span 12}
    table{min-width:720px} /* thân thiện mobile hơn */
  }
</style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="toolbar">
      <h1>Quản lý sửa chữa điện thoại</h1>
      <span class="chip">Dữ liệu lưu trên máy (local)</span>
      <span class="chip">Thiết bị: <span id="deviceType">...</span></span>
      <span class="chip">Giờ hệ thống: <span id="nowStr"></span></span>
    </div>
    <div class="tabs">
      <button class="tab-btn active" data-tab="le">Khách lẻ</button>
      <button class="tab-btn" data-tab="si">Khách sỉ</button>
      <button class="tab-btn" data-tab="debt">Công nợ</button>
      <button class="tab-btn" data-tab="report">Báo cáo</button>
      <span style="flex:1"></span>
      <button id="btnExportCsv" class="tab-btn">Xuất CSV</button>
      <label class="tab-btn" style="margin:0; cursor:pointer">
        Nhập CSV
        <input id="importCsv" type="file" accept=".csv,text/csv" style="display:none">
      </label>
      <button id="btnReset" class="tab-btn" style="border-color:var(--danger); color:var(--danger)">Xóa TẤT CẢ dữ liệu</button>
    </div>
  </div>
</header>

<main class="wrap" style="padding-top:12px">
  <!-- FORM KHÁCH LẺ -->
  <section id="tab-le">
    <div class="card">
      <h3>Thêm phiếu nhận – Khách lẻ</h3>
      <div class="grid">
        <div class="row-4">
          <label>Tên khách</label><input id="le_name" placeholder="Nguyễn Văn A">
        </div>
        <div class="row-4">
          <label>Tên máy</label><input id="le_device" placeholder="iPhone 13 Pro">
        </div>
        <div class="row-4">
          <label>IMEI (tuỳ chọn)</label><input id="le_imei" placeholder="35xxxxxxxxxxxxx">
        </div>
        <div class="row-4">
          <label>Mật khẩu/Mã máy (tuỳ chọn)</label><input id="le_pass" placeholder="0000">
        </div>
        <div class="row-4">
          <label>Tình trạng / Lỗi</label><input id="le_condition" placeholder="Vỡ kính, mất FaceID...">
        </div>
        <div class="row-4">
          <label>Giá tiền thu khách (VND)</label><input id="le_price" type="number" min="0" placeholder="1500000">
        </div>
        <div class="row-4">
          <label>Giá vốn / chi phí (VND)</label><input id="le_cost" type="number" min="0" placeholder="900000">
        </div>
        <div class="row-12">
          <label>Ghi chú</label><textarea id="le_note" placeholder="Phụ tùng thay mới, lịch hẹn..."></textarea>
        </div>
      </div>
      <div class="actions" style="margin-top:10px">
        <button class="btn primary" id="addLe">Thêm phiếu</button>
        <span class="hint">Phiếu mặc định ở trạng thái <b>Đã nhận</b>. Chỉ khi bấm <b>Đã giao</b> mới ghi nhận lợi nhuận/công nợ.</span>
      </div>
    </div>

    <div class="card" style="margin-top:12px">
      <div class="toolbar" style="justify-content:space-between">
        <div style="display:flex; gap:8px; flex-wrap:wrap">
          <input id="le_search" placeholder="Tìm tên/IMEI/trạng thái..." style="min-width:220px">
          <select id="le_statusFilter">
            <option value="">Tất cả trạng thái</option>
            <option value="received">Đã nhận</option>
            <option value="progress">Đang làm</option>
            <option value="delivered">Đã giao</option>
            <option value="debt">Công nợ</option>
          </select>
        </div>
        <div class="sum">
          <div class="kpi"><span class="hint">Đã giao (tháng này)</span><b id="kpiLeDelivered">0</b></div>
          <div class="kpi"><span class="hint">Lợi nhuận (tháng này)</span><b id="kpiLeProfit">0</b></div>
          <div class="kpi"><span class="hint">Công nợ hiện tại</span><b id="kpiLeDebt">0</b></div>
        </div>
      </div>
      <div class="table-wrap" id="le_tableWrap"></div>
    </div>
  </section>

  <!-- FORM KHÁCH SỈ -->
  <section id="tab-si" style="display:none">
    <div class="card">
      <h3>Thêm phiếu nhận – Khách sỉ</h3>
      <div class="grid">
        <div class="row-4">
          <label>Tên cửa hàng / Đối tác</label><input id="si_shop" placeholder="Cửa hàng ABC">
        </div>
        <div class="row-4">
          <label>Người liên hệ</label><input id="si_name" placeholder="Anh B">
        </div>
        <div class="row-4">
          <label>Tên máy</label><input id="si_device" placeholder="Samsung S22">
        </div>
        <div class="row-4">
          <label>IMEI (tuỳ chọn)</label><input id="si_imei" placeholder="35xxxxxxxxxxxxx">
        </div>
        <div class="row-4">
          <label>Mật khẩu/Mã máy (tuỳ chọn)</label><input id="si_pass" placeholder="1234">
        </div>
        <div class="row-4">
          <label>Tình trạng / Lỗi</label><input id="si_condition" placeholder="Không sạc, chập nguồn...">
        </div>
        <div class="row-4">
          <label>Giá tiền thu (VND)</label><input id="si_price" type="number" min="0" placeholder="1200000">
        </div>
        <div class="row-4">
          <label>Giá vốn / chi phí (VND)</label><input id="si_cost" type="number" min="0" placeholder="800000">
        </div>
        <div class="row-12">
          <label>Ghi chú</label><textarea id="si_note" placeholder="Điều khoản sỉ, lịch giao..."></textarea>
        </div>
      </div>
      <div class="actions" style="margin-top:10px">
        <button class="btn primary" id="addSi">Thêm phiếu</button>
        <span class="hint">Chỉ tính lợi nhuận/công nợ khi bấm <b>Đã giao</b>.</span>
      </div>
    </div>

    <div class="card" style="margin-top:12px">
      <div class="toolbar" style="justify-content:space-between">
        <div style="display:flex; gap:8px; flex-wrap:wrap">
          <input id="si_search" placeholder="Tìm shop/IMEI/trạng thái..." style="min-width:220px">
          <select id="si_statusFilter">
            <option value="">Tất cả trạng thái</option>
            <option value="received">Đã nhận</option>
            <option value="progress">Đang làm</option>
            <option value="delivered">Đã giao</option>
            <option value="debt">Công nợ</option>
          </select>
        </div>
        <div class="sum">
          <div class="kpi"><span class="hint">Đã giao (tháng này)</span><b id="kpiSiDelivered">0</b></div>
          <div class="kpi"><span class="hint">Lợi nhuận (tháng này)</span><b id="kpiSiProfit">0</b></div>
          <div class="kpi"><span class="hint">Công nợ hiện tại</span><b id="kpiSiDebt">0</b></div>
        </div>
      </div>
      <div class="table-wrap" id="si_tableWrap"></div>
    </div>
  </section>

  <!-- CÔNG NỢ -->
  <section id="tab-debt" style="display:none">
    <div class="card">
      <div class="toolbar" style="justify-content:space-between">
        <div style="display:flex; gap:8px; flex-wrap:wrap">
          <input id="debt_search" placeholder="Tìm tên/IMEI/loại (lẻ/sỉ)..." style="min-width:240px">
        </div>
        <div class="sum">
          <div class="kpi"><span class="hint">Tổng công nợ</span><b id="kpiDebtTotal">0</b></div>
          <div class="kpi"><span class="hint">Số phiếu nợ</span><b id="kpiDebtCount">0</b></div>
        </div>
      </div>
      <div class="table-wrap" id="debt_tableWrap"></div>
      <p class="hint" style="margin-top:8px">Ghi nhận thanh toán sẽ tự động cập nhật trạng thái nợ. Khi trả hết → phiếu chuyển về <b>Đã giao</b>.</p>
    </div>
  </section>

  <!-- BÁO CÁO -->
  <section id="tab-report" style="display:none">
    <div class="card">
      <h3>Báo cáo lợi nhuận (chỉ tính các phiếu đã bấm <span class="pill">Đã giao</span>)</h3>
      <div class="actions" style="margin:10px 0">
        <button class="btn" data-range="today">Hôm nay</button>
        <button class="btn" data-range="week">Tuần này</button>
        <button class="btn" data-range="month">Tháng này</button>
        <span class="hint">hoặc chọn khoảng ngày:</span>
        <input id="rp_from" type="date"> —
        <input id="rp_to" type="date">
        <button class="btn primary" id="rp_apply">Áp dụng</button>
      </div>
      <div class="sum" style="margin:8px 0">
        <div class="kpi"><span class="hint">Tổng doanh thu</span><b id="rp_revenue">0</b></div>
        <div class="kpi"><span class="hint">Tổng chi phí</span><b id="rp_cost">0</b></div>
        <div class="kpi"><span class="hint">Lợi nhuận</span><b id="rp_profit">0</b></div>
        <div class="kpi"><span class="hint">Số phiếu</span><b id="rp_count">0</b></div>
      </div>
      <div class="table-wrap" id="rp_tableWrap"></div>
    </div>
  </section>
</main>

<!-- DIALOG -->
<div id="dialog" style="position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.3)">
  <div class="card" style="max-width:520px; width:min(92vw,520px)">
    <h3 id="dg_title">Tiêu đề</h3>
    <div id="dg_body"></div>
    <div class="actions" style="margin-top:12px; justify-content:flex-end">
      <button class="btn" id="dg_cancel">Hủy</button>
      <button class="btn success" id="dg_ok">Xác nhận</button>
    </div>
  </div>
</div>

<script>
/** ========= Utilities ========= **/
const $ = s => document.querySelector(s);
const fmt = new Intl.NumberFormat('vi-VN');
function toDateOnly(d){ const t = new Date(d); t.setHours(0,0,0,0); return t; }
function startOfWeek(d=new Date()){ const t = new Date(d); const day=(t.getDay()+6)%7; t.setHours(0,0,0,0); t.setDate(t.getDate()-day); return t; }
function startOfMonth(d=new Date()){ const t = new Date(d.getFullYear(), d.getMonth(), 1); t.setHours(0,0,0,0); return t; }
function inRange(ts, from, to){ const x=new Date(ts); x.setHours(0,0,0,0); return (!from || x>=from)&&(!to || x<=to); }
function uid(){ return Math.random().toString(36).slice(2,10)+Date.now().toString(36).slice(-4); }

function detectDevice(){
  const ua = navigator.userAgent || '';
  const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(ua);
  return isMobile ? 'Mobile' : 'PC';
}
function nowStr(){ const n = new Date(); return n.toLocaleString('vi-VN'); }
document.addEventListener('DOMContentLoaded', ()=>{
  const el = document.getElementById('nowStr');
  if(el){ el.textContent = nowStr(); setInterval(()=> el.textContent = nowStr(), 1000); }
  const dev = document.getElementById('deviceType');
  if(dev) dev.textContent = detectDevice();
});

/** ========= Storage ========= **/
const KEY='repairAppV1';
let db = load();

function load(){
  try{ return JSON.parse(localStorage.getItem(KEY)) || { le:[], si:[] }; }
  catch{ return { le:[], si:[] }; }
}
function save(){ localStorage.setItem(KEY, JSON.stringify(db)); }

/** ========= Model ========= **/
function makeRecord(type, fields){
  return {
    id: uid(), type,
    name: fields.name?.trim()||'',
    shop: fields.shop?.trim()||'',
    device: fields.device?.trim()||'',
    imei: fields.imei?.trim()||'',
    pass: fields.pass?.trim()||'',
    condition: fields.condition?.trim()||'',
    price: Number(fields.price||0),
    cost: Number(fields.cost||0),
    note: fields.note?.trim()||'',
    status: 'received',
    createdAt: new Date().toISOString(),
    deliveredAt: null,
    payments: []
  };
}
function listAll(){ return [...db.le, ...db.si]; }
function setRecord(rec){
  if(rec.type==='le'){ const i=db.le.findIndex(x=>x.id===rec.id); if(i>-1) db.le[i]=rec; }
  else { const i=db.si.findIndex(x=>x.id===rec.id); if(i>-1) db.si[i]=rec; }
  save();
}
function removeRecord(type,id){
  if(type==='le'){ db.le = db.le.filter(x=>x.id!==id); }
  else { db.si = db.si.filter(x=>x.id!==id); }
  save();
}

/** ========= Helpers ========= **/
function statusBadge(s){
  const map = {received:'st-received', progress:'st-progress', delivered:'st-delivered', debt:'st-debt'};
  const text = {received:'Đã nhận', progress:'Đang làm', delivered:'Đã giao', debt:'Công nợ'};
  return `<span class="status ${map[s]||''}">${text[s]||s}</span>`;
}
function actionsCell(rec){
  return `
    <div class="actions">
      ${rec.status!=='delivered' ? `<button class="btn success" data-act="deliver" data-id="${rec.id}" data-type="${rec.type}">Đã giao</button>`:''}
      <button class="btn" data-act="edit" data-id="${rec.id}" data-type="${rec.type}">Sửa</button>
      <button class="btn warn" data-act="progress" data-id="${rec.id}" data-type="${rec.type}">Đang làm</button>
      <button class="btn danger" data-act="delete" data-id="${rec.id}" data-type="${rec.type}">Xóa</button>
      <button class="btn ghost" data-act="debt" data-id="${rec.id}" data-type="${rec.type}">Công nợ</button>
    </div>`;
}
function money(n){ return n? fmt.format(n): '0'; }
function owed(rec){
  const paid = rec.payments.reduce((s,p)=>s+Number(p.amount||0),0);
  return Math.max(0, Number(rec.price||0) - paid);
}
function profit(rec){ return Number(rec.price||0) - Number(rec.cost||0); }

/** ========= Tables ========= **/
function renderTable(type){
  const wrap = type==='le'? document.getElementById('le_tableWrap') : document.getElementById('si_tableWrap');
  const q = (type==='le'? document.getElementById('le_search') : document.getElementById('si_search')).value.trim().toLowerCase();
  const st = (type==='le'? document.getElementById('le_statusFilter') : document.getElementById('si_statusFilter')).value;
  const arr = (type==='le'? db.le : db.si).filter(r=>{
    const hay = [r.name, r.shop, r.device, r.imei, r.condition, r.note, r.status].join(' ').toLowerCase();
    const okQ = !q || hay.includes(q);
    const okS = !st || r.status===st;
    return okQ && okS;
  }).sort((a,b)=> new Date(b.createdAt)-new Date(a.createdAt));

  let html = `<table><thead><tr>
    <th class="nowrap">Ngày nhận</th>
    <th>${type==='le'?'Khách':'Cửa hàng'}</th>
    <th>Máy</th>
    <th>IMEI</th>
    <th>Tình trạng</th>
    <th class="nowrap">Giá thu</th>
    <th class="nowrap">Giá vốn</th>
    <th>Trạng thái</th>
    <th class="nowrap">Ngày giao</th>
    <th class="nowrap">Còn nợ</th>
    <th>Ghi chú</th>
    <th>Thao tác</th>
  </tr></thead><tbody>`;

  for(const r of arr){
    const debtCell = (r.status==='debt' ? `<span class="pill" style="background:#fee2e2;color:#7f1d1d">${money(owed(r))}</span>` : '-');
    html += `<tr>
      <td>${new Date(r.createdAt).toLocaleDateString('vi-VN')}</td>
      <td>${type==='le'?(r.name||'-'):(r.shop||'-')}</td>
      <td>${r.device||'-'}</td>
      <td>${r.imei||'-'}</td>
      <td>${r.condition||'-'}</td>
      <td class="nowrap">${money(r.price)}</td>
      <td class="nowrap">${money(r.cost)}</td>
      <td>${statusBadge(r.status)}</td>
      <td>${r.deliveredAt? new Date(r.deliveredAt).toLocaleString('vi-VN'): '-'}</td>
      <td class="nowrap">${debtCell}</td>
      <td>${r.note||''}</td>
      <td>${actionsCell(r)}</td>
    </tr>`;
  }
  html += `</tbody></table>`;
  wrap.innerHTML = html;

  wrap.querySelectorAll('[data-act]').forEach(btn=>{
    btn.addEventListener('click', onActionBtn);
  });

  // KPIs
  const first = startOfMonth(new Date());
  const delivered = (type==='le'? db.le:db.si).filter(x=>x.deliveredAt && new Date(x.deliveredAt)>=first);
  const profitSum = delivered.reduce((s,x)=> s + profit(x), 0);
  const debtSum = (type==='le'? db.le:db.si).filter(x=>x.status==='debt').reduce((s,x)=> s + owed(x), 0);
  (type==='le'? document.getElementById('kpiLeDelivered'):document.getElementById('kpiSiDelivered')).textContent = delivered.length;
  (type==='le'? document.getElementById('kpiLeProfit'):document.getElementById('kpiSiProfit')).textContent = money(profitSum);
  (type==='le'? document.getElementById('kpiLeDebt'):document.getElementById('kpiSiDebt')).textContent = money(debtSum);
}

function onActionBtn(e){
  const btn = e.currentTarget;
  const act = btn.dataset.act;
  const id = btn.dataset.id;
  const type = btn.dataset.type;
  const rec = (type==='le'? db.le:db.si).find(x=>x.id===id);
  if(!rec) return;

  if(act==='delete'){
    if(confirm('Xóa phiếu này?')){ removeRecord(type,id); renderAll(); }
    return;
  }
  if(act==='progress'){
    rec.status='progress'; setRecord(rec); renderAll(); return;
  }
  if(act==='edit'){
    openEditDialog(rec);
    return;
  }
  if(act==='deliver'){
    openDeliverDialog(rec);
    return;
  }
  if(act==='debt'){
    openDebtDialog(rec);
    return;
  }
}

/** ========= Dialogs ========= **/
const dialog = document.getElementById('dialog'), dgTitle = document.getElementById('dg_title'), dgBody = document.getElementById('dg_body'), dgOk=document.getElementById('dg_ok'), dgCancel=document.getElementById('dg_cancel');
dgCancel.onclick = ()=> closeDialog();

function openDialog(title, bodyHTML, onOk){
  dgTitle.textContent = title;
  dgBody.innerHTML = bodyHTML;
  dialog.style.display='flex';
  const ok = ()=>{ onOk?.(); closeDialog(); };
  dgOk.onclick = ok;
}
function closeDialog(){ dialog.style.display='none'; dgBody.innerHTML=''; dgOk.onclick=null; }

function openDeliverDialog(rec){
  const remaining = rec.price - rec.payments.reduce((s,p)=>s+Number(p.amount||0),0);
  const body = `
    <div class="grid">
      <div class="row-12"><b>Xác nhận giao máy</b></div>
      <div class="row-6">
        <label>Số tiền khách trả ngay (VND)</label>
        <input id="pay_now" type="number" min="0" value="${Math.max(0, remaining)}">
      </div>
      <div class="row-6">
        <label>Ghi chú thanh toán</label>
        <input id="pay_note" placeholder="Tiền mặt / chuyển khoản / công nợ...">
      </div>
      <div class="row-12 hint">Nếu khách chưa trả đủ, phần còn lại sẽ chuyển sang <b>công nợ</b>.</div>
    </div>`;
  openDialog('Đã giao máy', body, ()=>{
    const payNow = Number(document.getElementById('pay_now').value||0);
    const note = document.getElementById('pay_note').value?.trim()||'';
    if(payNow>0){ rec.payments.push({amount:payNow, note, at:new Date().toISOString()}); }
    rec.deliveredAt = new Date().toISOString();
    rec.status = owed(rec)>0 ? 'debt' : 'delivered';
    setRecord(rec); renderAll();
  });
}

function openDebtDialog(rec){
  const body = `
    <div class="grid">
      <div class="row-6">
        <label>Số tiền khách trả thêm (VND)</label>
        <input id="pay_more" type="number" min="0" value="${owed(rec)}">
      </div>
      <div class="row-6">
        <label>Ghi chú</label>
        <input id="pay_more_note" placeholder="Thu nợ đợt 2...">
      </div>
      <div class="row-12">
        <div class="hint">Còn nợ hiện tại: <b>${money(owed(rec))} VND</b></div>
      </div>
    </div>`;
  openDialog('Ghi nhận thanh toán công nợ', body, ()=>{
    const n = Number(document.getElementById('pay_more').value||0);
    const note = document.getElementById('pay_more_note').value?.trim()||'';
    if(n>0){ rec.payments.push({amount:n, note, at:new Date().toISOString()}); }
    if(!rec.deliveredAt) rec.deliveredAt=new Date().toISOString();
    rec.status = owed(rec)>0 ? 'debt' : 'delivered';
    setRecord(rec); renderAll();
  });
}

function openEditDialog(rec){
  const body = `
    <div class="grid">
      <div class="row-6"><label>${rec.type==='le'?'Tên khách':'Cửa hàng'}</label><input id="ed_name" value="${rec.type==='le'? (rec.name||'') : (rec.shop||'')}"></div>
      ${rec.type==='si'? `<div class="row-6"><label>Người liên hệ</label><input id="ed_contact" value="${rec.name||''}"></div>`:''}
      <div class="row-6"><label>Tên máy</label><input id="ed_device" value="${rec.device||''}"></div>
      <div class="row-6"><label>IMEI</label><input id="ed_imei" value="${rec.imei||''}"></div>
      <div class="row-6"><label>Mật khẩu/Mã máy</label><input id="ed_pass" value="${rec.pass||''}"></div>
      <div class="row-6"><label>Tình trạng</label><input id="ed_condition" value="${rec.condition||''}"></div>
      <div class="row-6"><label>Giá thu (VND)</label><input id="ed_price" type="number" value="${rec.price||0}"></div>
      <div class="row-6"><label>Giá vốn (VND)</label><input id="ed_cost" type="number" value="${rec.cost||0}"></div>
      <div class="row-12"><label>Ghi chú</label><textarea id="ed_note">${rec.note||''}</textarea></div>
      <div class="row-6">
        <label>Trạng thái</label>
        <select id="ed_status">
          <option value="received" ${rec.status==='received'?'selected':''}>Đã nhận</option>
          <option value="progress" ${rec.status==='progress'?'selected':''}>Đang làm</option>
          <option value="delivered" ${rec.status==='delivered'?'selected':''}>Đã giao</option>
          <option value="debt" ${rec.status==='debt'?'selected':''}>Công nợ</option>
        </select>
      </div>
    </div>`;
  openDialog('Sửa phiếu', body, ()=>{
    if(rec.type==='le'){ rec.name = document.getElementById('ed_name').value.trim(); }
    else { rec.shop = document.getElementById('ed_name').value.trim(); rec.name = (document.getElementById('ed_contact').value||'').trim(); }
    rec.device = document.getElementById('ed_device').value.trim();
    rec.imei = document.getElementById('ed_imei').value.trim();
    rec.pass = document.getElementById('ed_pass').value.trim();
    rec.condition = document.getElementById('ed_condition').value.trim();
    rec.price = Number(document.getElementById('ed_price').value||0);
    rec.cost = Number(document.getElementById('ed_cost').value||0);
    rec.note = document.getElementById('ed_note').value.trim();
    const newStatus = document.getElementById('ed_status').value;
    rec.status = newStatus;
    if(newStatus==='delivered' && !rec.deliveredAt) rec.deliveredAt=new Date().toISOString();
    setRecord(rec); renderAll();
  });
}

/** ========= Add handlers ========= **/
document.getElementById('addLe').onclick = ()=>{
  const rec = makeRecord('le',{
    name: document.getElementById('le_name').value,
    device: document.getElementById('le_device').value,
    imei: document.getElementById('le_imei').value,
    pass: document.getElementById('le_pass').value,
    condition: document.getElementById('le_condition').value,
    price: document.getElementById('le_price').value,
    cost: document.getElementById('le_cost').value,
    note: document.getElementById('le_note').value,
  });
  db.le.push(rec); save(); clearForm('le'); renderAll();
};
document.getElementById('addSi').onclick = ()=>{
  const rec = makeRecord('si',{
    shop: document.getElementById('si_shop').value,
    name: document.getElementById('si_name').value,
    device: document.getElementById('si_device').value,
    imei: document.getElementById('si_imei').value,
    pass: document.getElementById('si_pass').value,
    condition: document.getElementById('si_condition').value,
    price: document.getElementById('si_price').value,
    cost: document.getElementById('si_cost').value,
    note: document.getElementById('si_note').value,
  });
  db.si.push(rec); save(); clearForm('si'); renderAll();
};
function clearForm(type){
  const ids = type==='le'?
    ['le_name','le_device','le_imei','le_pass','le_condition','le_price','le_cost','le_note']:
    ['si_shop','si_name','si_device','si_imei','si_pass','si_condition','si_price','si_cost','si_note'];
  ids.forEach(id=>{ const el=document.getElementById(id); if(!el) return; el.value=''; });
}

/** ========= Filters & KPIs ========= **/
['le_search','si_search','le_statusFilter','si_statusFilter'].forEach(id=>{
  const el = document.getElementById(id); if(el) el.addEventListener('input', ()=> renderAll());
});

/** ========= Debt view ========= **/
function renderDebt(){
  const q = document.getElementById('debt_search').value.trim().toLowerCase();
  const arr = listAll()
    .filter(r=> r.status==='debt' && owed(r)>0 )
    .filter(r=>{
      const hay = [r.type, r.name, r.shop, r.device, r.imei, r.condition, r.note].join(' ').toLowerCase();
      return !q || hay.includes(q);
    })
    .sort((a,b)=> (owed(b)-owed(a)) || (new Date(b.createdAt)-new Date(a.createdAt)));

  let html = `<table><thead><tr>
    <th>Loại</th><th>Khách/Shop</th><th>Máy</th><th>IMEI</th>
    <th>Giá thu</th><th>Đã trả</th><th>Còn nợ</th><th>Ngày giao</th><th>Thao tác</th>
  </tr></thead><tbody>`;
  for(const r of arr){
    const paid = r.payments.reduce((s,p)=>s+Number(p.amount||0),0);
    html += `<tr>
      <td class="nowrap">${r.type==='le'?'Lẻ':'Sỉ'}</td>
      <td>${r.type==='le'?(r.name||'-'):(r.shop||'-')}</td>
      <td>${r.device||'-'}</td>
      <td>${r.imei||'-'}</td>
      <td class="nowrap">${money(r.price)}</td>
      <td class="nowrap">${money(paid)}</td>
      <td class="nowrap"><b>${money(owed(r))}</b></td>
      <td>${r.deliveredAt? new Date(r.deliveredAt).toLocaleDateString('vi-VN'):'-'}</td>
      <td><button class="btn success" data-act="debt" data-id="${r.id}" data-type="${r.type}">Thu nợ</button></td>
    </tr>`;
  }
  html += `</tbody></table>`;
  document.getElementById('debt_tableWrap').innerHTML = html;

  document.getElementById('kpiDebtTotal').textContent = money(arr.reduce((s,x)=> s+owed(x),0));
  document.getElementById('kpiDebtCount').textContent = arr.length;

  document.getElementById('debt_tableWrap').querySelectorAll('[data-act="debt"]').forEach(btn=> btn.addEventListener('click', onActionBtn));
}
document.getElementById('debt_search').addEventListener('input', renderDebt);

/** ========= Reports ========= **/
function renderReport(range){
  let from=null, to=null;
  if(range==='today'){ from=toDateOnly(new Date()); to=toDateOnly(new Date()); }
  else if(range==='week'){ from=startOfWeek(new Date()); to=toDateOnly(new Date()); }
  else if(range==='month'){ from=startOfMonth(new Date()); to=toDateOnly(new Date()); }
  else{
    const f=document.getElementById('rp_from').value, t=document.getElementById('rp_to').value;
    if(f) from = toDateOnly(new Date(f));
    if(t) to = toDateOnly(new Date(t));
  }

  const arr = listAll().filter(r=> r.deliveredAt && inRange(r.deliveredAt, from, to));
  const revenue = arr.reduce((s,r)=> s + Number(r.price||0), 0);
  const cost = arr.reduce((s,r)=> s + Number(r.cost||0), 0);
  const prof = revenue - cost;

  document.getElementById('rp_revenue').textContent = money(revenue);
  document.getElementById('rp_cost').textContent = money(cost);
  document.getElementById('rp_profit').textContent = money(prof);
  document.getElementById('rp_count').textContent = arr.length;

  let html = `<table><thead><tr>
    <th>Ngày giao</th><th>Loại</th><th>Khách/Shop</th><th>Máy</th>
    <th>Giá thu</th><th>Giá vốn</th><th>Lợi nhuận</th><th>IMEI</th><th>Ghi chú</th>
  </tr></thead><tbody>`;
  for(const r of arr.sort((a,b)=> new Date(b.deliveredAt)-new Date(a.deliveredAt))){
    html += `<tr>
      <td>${new Date(r.deliveredAt).toLocaleString('vi-VN')}</td>
      <td class="nowrap">${r.type==='le'?'Lẻ':'Sỉ'}</td>
      <td>${r.type==='le'?(r.name||'-'):(r.shop||'-')}</td>
      <td>${r.device||'-'}</td>
      <td class="nowrap">${money(r.price)}</td>
      <td class="nowrap">${money(r.cost)}</td>
      <td class="nowrap"><b>${money(profit(r))}</b></td>
      <td>${r.imei||'-'}</td>
      <td>${r.note||''}</td>
    </tr>`;
  }
  html += `</tbody></table>`;
  document.getElementById('rp_tableWrap').innerHTML = html;
}
document.querySelectorAll('#tab-report .btn[data-range]').forEach(b=>{
  b.addEventListener('click', ()=>{ renderReport(b.dataset.range); });
});
document.getElementById('rp_apply').onclick = ()=> renderReport('custom');

/** ========= Export CSV / Import CSV / Reset ========= **/
function csvEscape(v){
  if(v==null) v='';
  v = String(v);
  if(v.includes('"')) v = v.replace(/"/g, '""');
  if(/[",\n]/.test(v)) return `"${v}"`;
  return v;
}
function toCSV(){
  const rows = [['id','type','name','shop','device','imei','pass','condition','price','cost','note','status','createdAt','deliveredAt','paid','payments_detail']];
  const all = listAll();
  for(const r of all){
    const paid = r.payments.reduce((s,p)=> s + Number(p.amount||0), 0);
    const paymentsDetail = r.payments.map(p=> `${p.amount}|${(p.note||'').replaceAll('|','/') }|${p.at}`).join(';');
    rows.push([r.id,r.type,r.name,r.shop,r.device,r.imei,r.pass,r.condition,r.price,r.cost,r.note,r.status,r.createdAt||'',r.deliveredAt||'',paid, paymentsDetail]);
  }
  return rows.map(row => row.map(csvEscape).join(',')).join('\n');
}

function parseCSV(text){
  const rows=[]; let i=0, cur='', inQ=false, row=[];
  while(i<text.length){
    const c=text[i];
    if(inQ){
      if(c==='"'){
        if(text[i+1]==='"'){ cur+='"'; i++; } else { inQ=false; }
      } else { cur+=c; }
    } else {
      if(c==='"'){ inQ=true; }
      else if(c===','){ row.push(cur); cur=''; }
      else if(c==='\n'){
        row.push(cur); rows.push(row); row=[]; cur='';
      } else if(c==='\r'){ /* skip */ }
      else { cur+=c; }
    }
    i++;
  }
  row.push(cur); rows.push(row);
  // header
  const header = rows.shift().map(h=>h.trim());
  return rows.filter(r=> r.some(x=>x.trim()!=='')).map(cols=>{
    const obj={};
    header.forEach((h,idx)=> obj[h]= cols[idx]??'');
    return obj;
  });
}

document.getElementById('btnExportCsv').onclick = ()=>{
  const csv = toCSV();
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `repair-data-${new Date().toISOString().slice(0,10)}.csv`;
  a.click();
};

document.getElementById('importCsv').addEventListener('change', async (e)=>{
  const f = e.target.files?.[0]; if(!f) return;
  const txt = await f.text();
  try{
    const items = parseCSV(txt);
    const next = { le:[], si:[] };
    for(const it of items){
      const rec = {
        id: it.id || uid(),
        type: (it.type==='si'?'si':'le'),
        name: it.name||'',
        shop: it.shop||'',
        device: it.device||'',
        imei: it.imei||'',
        pass: it.pass||'',
        condition: it.condition||'',
        price: Number(it.price||0),
        cost: Number(it.cost||0),
        note: it.note||'',
        status: it.status||'received',
        createdAt: it.createdAt || new Date().toISOString(),
        deliveredAt: it.deliveredAt || null,
        payments: []
      };
      // payments detail
      if(it.payments_detail){
        const parts = String(it.payments_detail).split(';').filter(Boolean);
        for(const p of parts){
          const [amount, note, at] = p.split('|');
          if(amount && !isNaN(Number(amount))){
            rec.payments.push({amount:Number(amount), note: note||'', at: at || new Date().toISOString()});
          }
        }
      } else if(it.paid && Number(it.paid)>0){
        rec.payments.push({amount:Number(it.paid), note:'Imported', at:new Date().toISOString()});
      }
      // adjust status consistency
      const stillOwed = Math.max(0, Number(rec.price||0) - rec.payments.reduce((s,p)=>s+Number(p.amount||0),0));
      if(rec.deliveredAt){
        rec.status = stillOwed>0 ? 'debt' : (rec.status==='delivered'?'delivered':'delivered');
      } else {
        if(rec.status==='debt') rec.status='received'; // chưa giao thì không thể là nợ
      }
      if(rec.type==='le') next.le.push(rec); else next.si.push(rec);
    }
    db = next; save(); renderAll();
    alert('Nhập CSV thành công!');
  }catch(err){
    alert('Không thể đọc CSV. Vui lòng kiểm tra định dạng.');
  }
  e.target.value='';
});

document.getElementById('btnReset').onclick = ()=>{
  if(confirm('Bạn chắc chắn muốn xóa TẤT CẢ dữ liệu?')){ db={le:[], si:[]}; save(); renderAll(); }
};

/** ========= Tabs ========= **/
document.querySelectorAll('.tab-btn[data-tab]').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    document.querySelectorAll('.tab-btn[data-tab]').forEach(b=> b.classList.remove('active'));
    btn.classList.add('active');
    const tab = btn.dataset.tab;
    document.querySelectorAll('main section').forEach(s=> s.style.display='none');
    document.getElementById('tab-'+tab).style.display='block';
    if(tab==='report') renderReport('month');
  });
});

/** ========= Initial render ========= **/
function renderAll(){
  renderTable('le');
  renderTable('si');
  renderDebt();
}
renderAll();
</script>
</body>
</html>
